NIP-57
======

闪电打赏
--------------

`草案` `可选`

本 NIP 定义了两种新的事件类型，用于记录用户之间的闪电支付。`9734` 是 `打赏请求`，表示付款人向收款人的闪电钱包请求发票的请求。`9735` 是 `打赏收据`，表示收款人的闪电钱包确认响应 `打赏请求` 而发出的发票已被支付。

在 nostr 上拥有闪电收据允许客户端显示来自网络上实体的闪电支付。这些可以用于娱乐或垃圾邮件威慑。

## 协议流程

1. 客户端从被打赏事件上的 `zap` 标签（参见附录 G）计算收款人的 lnurl 支付请求 URL，或通过根据 [lnurl 规范](https://github.com/lnurl/luds)解码其档案上的 lud06 或 lud16 字段。客户端必须向此 URL 发送 GET 请求并解析响应。如果 `allowsNostr` 存在且为 `true`，并且如果 `nostrPubkey` 存在且是有效的 BIP 340 十六进制公钥，客户端应将此信息与用户关联，以及响应的 `callback`、`minSendable` 和 `maxSendable` 值。
2. 客户端可以选择在每个帖子或用户档案上显示闪电打赏按钮。如果用户的 lnurl 支付请求端点支持 nostr，客户端应该使用此 NIP 请求 `打赏收据` 而不是普通的 lnurl 发票。
3. 当用户（"发送者"）表示他们想要向另一个用户（"收款人"）发送打赏时，客户端应创建本 NIP 附录 A 中描述的 `打赏请求` 事件并签名。
4. 不应发布 `打赏请求`，而应将 `9734` 事件发送到从收款人的 lnurl 支付端点收到的 `callback` URL，使用 GET 请求。详细信息和示例请参见附录 B。
5. 收款人的 lnurl 服务器将接收此 `打赏请求` 并验证它。有关如何正确配置 lnurl 服务器以支持打赏的详细信息，请参见附录 C，有关如何验证 `nostr` 查询参数的详细信息，请参见附录 D。
6. 如果 `打赏请求` 有效，服务器应获取描述哈希发票，其中描述是此 `打赏请求` 笔记，仅此笔记。描述中不包含额外的 lnurl 元数据。这将根据 [LUD06](https://github.com/lnurl/luds/blob/luds/06.md) 在响应中返回。
7. 收到发票后，客户端可以支付它或将其传递给可以支付发票的应用程序。
8. 一旦发票被支付，收款人的 lnurl 服务器必须生成附录 E 中描述的 `打赏收据`，并将其发布到 `打赏请求` 中指定的 `relays`。
9. 客户端可以获取帖子和档案上的 `打赏收据`，但必须如附录 F 中描述的那样授权其有效性。如果 `打赏请求` 笔记包含非空 `content`，它可能显示打赏评论。通常客户端应该向用户显示 `打赏请求` 笔记，并使用 `打赏收据` 显示"打赏由...授权"，但这是可选的。

## 参考和示例

### 附录 A：打赏请求事件

`打赏请求` 是种类 `9734` 的事件，_不_ 发布到中继器，而是发送到收款人的 lnurl 支付 `callback` URL。此事件的 `content` 可能是与支付一起发送的可选消息。事件必须包含以下标签：

- `relays` 是收款人钱包应将其 `打赏收据` 发布到的中继器列表。注意中继器不应嵌套在额外列表中，而应如下面示例所示包含。
- `amount` 是发送者打算支付的 _毫聪_ 金额，格式化为字符串。这是推荐的，但可选的。
- `lnurl` 是收款人的 lnurl 支付 URL，使用带有前缀 `lnurl` 的 bech32 编码。这是推荐的，但可选的。
- `p` 是收款人的十六进制编码公钥。

此外，事件可能包含以下标签：

- `e` 是可选的十六进制编码事件 ID。如果打赏事件而不是人，客户端必须包含此项。
- `a` 是可选的事件坐标，允许打赏可寻址事件，如 NIP-23 长篇笔记。
- `k` 是目标事件的字符串化种类。

示例：

```json
{
  "kind": 9734,
  "content": "打赏！",
  "tags": [
    ["relays", "wss://nostr-pub.wellorder.com", "wss://anotherrelay.example.com"],
    ["amount", "21000"],
    ["lnurl", "lnurl1dp68gurn8ghj7um5v93kketj9ehx2amn9uh8wetvdskkkmn0wahz7mrww4excup0dajx2mrv92x9xp"],
    ["p", "04c915daefee38317fa734444acee390a8269fe5810b2241e5e6dd343dfbecc9"],
    ["e", "9ae37aa68f48645127299e9453eb5d908a0cbb6058ff340d528ed4d37c8994fb"],
    ["k", "1"]
  ],
  "pubkey": "97c70a44366a6535c145b333f973ea86dfdc2d7a99da618c40c64705ad98e322",
  "created_at": 1679673265,
  "id": "30efed56a035b2549fcaeec0bf2c1595f9a9b3bb4b1a38abaf8ee9041c4b7d93",
  "sig": "f2cb581a84ed10e4dc84937bd98e27acac71ab057255f6aa8dfa561808c981fe8870f4a03c1e3666784d82a9c802d3704e174371aa13d63e2aeaf24ff5374d9d"
}
```

### 附录 B：打赏请求 HTTP 请求

已签名的 `打赏请求` 事件不会发布，而是使用 HTTP GET 请求发送到收款人的 `callback` URL，该 URL 由收款人的 lnurl 支付端点提供。此请求应定义以下查询参数：

- `amount` 是发送者打算支付的 _毫聪_ 金额
- `nostr` 是 `9734` `打赏请求` 事件，JSON 编码然后 URI 编码
- `lnurl` 是收款人的 lnurl 支付 URL，使用带有前缀 `lnurl` 的 bech32 编码

此请求应返回带有 `pr` 键的 JSON 响应，这是发送者必须支付以完成打赏的发票。以下是 JavaScript 中的示例流程：

```javascript
const senderPubkey // 发送者的公钥
const recipientPubkey = // 收款人的公钥
const callback = // 从收款人 lnurl 支付端点收到的回调
const lnurl = // 收款人的闪电地址，编码为 lnurl
const sats = 21

const amount = sats * 1000
const relays = ['wss://nostr-pub.wellorder.net']
const event = encodeURI(JSON.stringify(await signEvent({
  kind: 9734,
  content: "",
  pubkey: senderPubkey,
  created_at: Math.round(Date.now() / 1000),
  tags: [
    ["relays", ...relays],
    ["amount", amount.toString()],
    ["lnurl", lnurl],
    ["p", recipientPubkey],
  ],
})))

const {pr: invoice} = await fetchJson(`${callback}?amount=${amount}&nostr=${event}&lnurl=${lnurl}`)
```

### 附录 C：LNURL 服务器配置

lnurl 服务器需要一些额外的信息，以便客户端可以知道支持打赏发票：

1. 向 lnurl-pay 静态端点 `/.well-known/lnurlp/<user>` 添加 `nostrPubkey`，其中 `nostrPubkey` 是您的服务器将用于签署 `打赏收据` 事件的 nostr 公钥。客户端将使用此来验证 `打赏收据`。
2. 添加 `allowsNostr` 字段并将其设置为 true。

### 附录 D：LNURL 服务器打赏请求验证

当客户端向服务器的 lnurl-pay 回调 URL 发送 `打赏请求` 事件时，将有一个 `nostr` 查询参数，其值是该事件，该事件经过 URI 和 JSON 编码。如果存在，`打赏请求` 事件必须以以下方式验证：

1. 它必须有有效的 nostr 签名
2. 它必须有标签
3. 它必须只有一个 `p` 标签
4. 它必须有 0 或 1 个 `e` 标签
5. 应该有一个 `relays` 标签，包含要发送 `打赏收据` 的中继器。
6. 如果有 `amount` 标签，它必须等于 `amount` 查询参数。
7. 如果有 `a` 标签，它必须是有效的事件坐标
8. 必须有 0 或 1 个 `P` 标签。如果有一个，它必须等于 `打赏收据` 的 `pubkey`。

然后必须存储该事件供以后使用，当发票被支付时。

### 附录 E：打赏收据事件

当由 `打赏请求` 生成的发票被支付时，闪电节点创建 `打赏收据`。只有当发票描述（提交到描述哈希）包含 `打赏请求` 笔记时，才会创建 `打赏收据`。

收到支付时，执行以下步骤：

1. 获取发票的描述。这需要在生成描述哈希发票期间保存在某处。它会自动为您保存在 CLN 中，这是这里使用的参考实现。
2. 将 bolt11 描述解析为 JSON nostr 事件。这应该根据附录 D 中的要求进行验证，要么在收到时，要么在支付发票之前。
3. 创建如下所述的种类 `9735` 的 nostr 事件，并将其发布到 `打赏请求` 中声明的 `relays`。

`打赏收据` 事件应该满足以下条件：

- `content` 应该为空。
- `created_at` 日期应该设置为发票 `paid_at` 日期以确保幂等性。
- `tags` 必须包含来自 `打赏请求` 的 `p` 标签（打赏收款人）和可选的 `e` 标签以及可选的 `a` 标签以及来自打赏请求公钥的可选 `P` 标签（打赏发送者）。
- `打赏收据` 必须有包含描述哈希 bolt11 发票的 `bolt11` 标签。
- `打赏收据` 必须包含 `description` 标签，这是 JSON 编码的打赏请求。
- `SHA256(description)` 应该匹配 bolt11 发票中的描述哈希。
- `打赏收据` 可能包含 `preimage` 标签以匹配 bolt11 发票的支付哈希。这实际上不是支付证明，没有真正的方法证明发票是真实的或已被支付。您信任 `打赏收据` 作者的支付合法性。

`打赏收据` 不是支付证明，它只证明某个 nostr 用户获取了发票。`打赏收据` 的存在意味着发票已支付，但给定恶意实现，它可能是谎言。

可以在[这里](https://github.com/jb55/cln-nostr-zapper)找到支持打赏的 lnurl 服务器的参考实现。

示例 `打赏收据`：

```json
{
    "id": "67b48a14fb66c60c8f9070bdeb37afdfcc3d08ad01989460448e4081eddda446",
    "pubkey": "9630f464cca6a5147aa8a35f0bcdd3ce485324e732fd39e09233b1d848238f31",
    "created_at": 1674164545,
    "kind": 9735,
    "tags": [
      ["p", "32e1827635450ebb3c5a7d12c1f8e7b2b514439ac10a67eef3d9fd9c5c68e245"],
      ["P", "97c70a44366a6535c145b333f973ea86dfdc2d7a99da618c40c64705ad98e322"],
      ["e", "3624762a1274dd9636e0c552b53086d70bc88c165bc4dc0f9e836a1eaf86c3b8"],
      ["k", "1"],
      ["bolt11", "lnbc10u1p3unwfusp5t9r3yymhpfqculx78u027lxspgxcr2n2987mx2j55nnfs95nxnzqpp5jmrh92pfld78spqs78v9euf2385t83uvpwk9ldrlvf6ch7tpascqhp5zvkrmemgth3tufcvflmzjzfvjt023nazlhljz2n9hattj4f8jq8qxqyjw5qcqpjrzjqtc4fc44feggv7065fqe5m4ytjarg3repr5j9el35xhmtfexc42yczarjuqqfzqqqqqqqqlgqqqqqqgq9q9qxpqysgq079nkq507a5tw7xgttmj4u990j7wfggtrasah5gd4ywfr2pjcn29383tphp4t48gquelz9z78p4cq7ml3nrrphw5w6eckhjwmhezhnqpy6gyf0"],
      ["description", "{\"pubkey\":\"97c70a44366a6535c145b333f973ea86dfdc2d7a99da618c40c64705ad98e322\",\"content\":\"\",\"id\":\"d9cc14d50fcb8c27539aacf776882942c1a11ea4472f8cdec1dea82fab66279d\",\"created_at\":1674164539,\"sig\":\"77127f636577e9029276be060332ea565deaf89ff215a494ccff16ae3f757065e2bc59b2e8c113dd407917a010b3abd36c8d7ad84c0e3ab7dab3a0b0caa9835d\",\"kind\":9734,\"tags\":[[\"e\",\"3624762a1274dd9636e0c552b53086d70bc88c165bc4dc0f9e836a1eaf86c3b8\"],[\"p\",\"32e1827635450ebb3c5a7d12c1f8e7b2b514439ac10a67eef3d9fd9c5c68e245\"],[\"relays\",\"wss://relay.damus.io\",\"wss://nostr-relay.wlvs.space\",\"wss://nostr.fmt.wiz.biz\",\"wss://relay.nostr.bg\",\"wss://nostr.oxtr.dev\",\"wss://nostr.v0l.io\",\"wss://brb.io\",\"wss://nostr.bitcoiner.social\",\"ws://monad.jb55.com:8080\",\"wss://relay.snort.social\"]]}"],
      ["preimage", "5d006d2cf1e73c7148e7519a4c68adc81642ce0e25a432b2434c99f97344c15f"]
    ],
    "content": "",
  }
```

### 附录 F：验证打赏收据

客户端可以使用 NIP-01 过滤器在事件和公钥上检索 `打赏收据`，例如 `{"kinds": [9735], "#e": [...]}`。必须使用以下步骤验证打赏：

- `打赏收据` 事件的 `pubkey` 必须与收款人的 lnurl 提供者的 `nostrPubkey`（在协议流程的步骤 1 中检索）相同。
- `打赏收据` 的 `bolt11` 标签中包含的 `invoiceAmount` 必须等于 `打赏请求` 的 `amount` 标签（如果存在）。
- `打赏请求` 的 `lnurl` 标签（如果存在）应该等于收款人的 `lnurl`。

### 附录 G：其他事件上的 `zap` 标签

当事件包含一个或多个 `zap` 标签时，希望打赏它的客户端应该根据标签值而不是事件作者的档案字段计算 lnurl 支付请求。标签的第二个参数是接收者公钥的 `hex` 字符串，第三个参数是下载接收者元数据（Kind-0）的中继器。可选的第四个参数指定分配给相应接收者的权重（百分比的泛化）。客户端应解析所有权重，计算总和，然后计算每个接收者的百分比。如果权重不存在，客户端应该将打赏金额平均分配给所有接收者。如果权重只是部分存在，没有权重的接收者不应被打赏（`weight = 0`）。

```jsonc
{
    "tags": [
        [ "zap", "82341f882b6eabcd2ba7f1ef90aad961cf074af15b9ef44a09f9d2a8fbfbe6a2", "wss://nostr.oxtr.dev", "1" ],  // 25%
        [ "zap", "fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52", "wss://nostr.wine/",    "1" ],  // 25%
        [ "zap", "460c25e682fda7832b52d1f22d3d22b3176d972f60dcdc3212ed8c92ef85065c", "wss://nos.lol/",       "2" ]   // 50%
    ]
}
```

客户端可以在笔记中显示打赏分配配置。

## 未来工作

打赏可以扩展为通过将 `打赏请求` 笔记加密给目标用户来更加私密，但为了简单起见，它已从此初始草案中省略。
