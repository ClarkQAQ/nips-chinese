NIP-13
======

工作量证明
-------------

`草案` `可选`

本 NIP 定义了为 nostr 笔记生成和解释工作量证明的方法。工作量证明（PoW）是向笔记添加计算工作证明的方法。这是所有中继器和客户端都可以用少量代码普遍验证的持有者证明。此证明可用作垃圾邮件威慑手段。

`difficulty`（难度）定义为 `NIP-01` ID 中前导零位的数量。例如，ID `000000000e9d97a1ab09fc381030b346cdd7a142ad57e6df0b46dc9bef6c7e2d` 的难度为 `36`，有 `36` 个前导 0 位。

`002f...` 在二进制中是 `0000 0000 0010 1111...`，有 10 个前导零。不要忘记计算十六进制数字 <= `7` 的前导零。

挖矿
------

要为 `NIP-01` 笔记生成 PoW，使用 `nonce` 标签：

```json
{"content": "It's just me mining my own business", "tags": [["nonce", "1", "21"]]}
```

挖矿时，nonce 标签的第二个条目会更新，然后重新计算 ID（参见 [NIP-01](./01_ZH.md)）。如果 ID 具有所需数量的前导零位，则笔记已被挖掘。建议在此过程中也更新 `created_at`。

nonce 标签的第三个条目应该包含目标难度。这允许客户端防止针对较低难度的批量垃圾邮件发送者幸运地匹配较高难度的情况。例如，如果您需要 40 位才能回复您的主题并看到承诺目标为 30，即使笔记有 40 位难度，您也可以安全地拒绝它。没有承诺目标难度，您无法拒绝它。承诺目标难度是所有诚实矿工都应该接受的，如果缺少难度承诺，客户端可以拒绝匹配目标难度的笔记。

示例挖掘笔记
------------------

```json
{
  "id": "000006d8c378af1779d2feebc7603a125d99eca0ccf1085959b307f64e5dd358",
  "pubkey": "a48380f4cfcc1ad5378294fcac36439770f9c878dd880ffa94bb74ea54a6f243",
  "created_at": 1651794653,
  "kind": 1,
  "tags": [
    ["nonce", "776797", "20"]
  ],
  "content": "It's just me mining my own business",
  "sig": "284622fc0a3f4f1303455d5175f7ba962a3300d136085b9566801bc2e0699de0c7e31e44c81fb40ad9049173742e904713c3594a1da0fc5d2382a25c11aba977"
}
```

验证
----------

这里是一些计算 nostr 事件 ID 中难度（即前导零位数量）的参考 C 代码：

```c
int zero_bits(unsigned char b)
{
        int n = 0;

        if (b == 0)
                return 8;

        while (b >>= 1)
                n++;

        return 7-n;
}

/* find the number of leading zero bits in a hash */
int count_leading_zero_bits(unsigned char *hash)
{
        int bits, total, i;
        for (i = 0, total = 0; i < 32; i++) {
                bits = zero_bits(hash[i]);
                total += bits;
                if (bits != 8)
                        break;
        }
        return total;
}
```

这里是一些执行相同操作的 JavaScript 代码：

```javascript
// hex 应该是十六进制字符串（没有 0x 前缀）
function countLeadingZeroes(hex) {
  let count = 0;

  for (let i = 0; i < hex.length; i++) {
    const nibble = parseInt(hex[i], 16);
    if (nibble === 0) {
      count += 4;
    } else {
      count += Math.clz32(nibble) - 28;
      break;
    }
  }

  return count;
}
```

委托工作量证明
-----------------------

由于 `NIP-01` 笔记 ID 不提交任何签名，PoW 可以外包给 PoW 提供商，可能收费。这为客户端提供了一种方式，让他们的消息传达到 PoW 限制的中继器，而无需自己做任何工作，这对于像手机这样的能量受限设备很有用。
