NIP-17
======

私密直接消息
-----------------------

`草案` `可选`

本 NIP 定义了一个使用 [NIP-44](44_ZH.md) 加密和 [NIP-59](59_ZH.md) 密封和礼品包装的加密直接消息方案。

## 直接消息种类

种类 `14` 是聊天消息。`p` 标签标识消息的一个或多个接收者。

```jsonc
{
  "id": "<常规哈希>",
  "pubkey": "<发送者公钥>",
  "created_at": "<当前时间>",
  "kind": 14,
  "tags": [
    ["p", "<接收者1公钥>", "<中继器URL>"],
    ["p", "<接收者2公钥>", "<中继器URL>"],
    ["e", "<种类14的ID>", "<中继器URL>"] // 如果这是回复
    ["subject", "<对话标题>"],
    // 其余标签...
  ],
  "content": "<纯文本消息>",
}
```

`.content` 必须是纯文本。字段 `id` 和 `created_at` 是必需的。

`e` 标签表示此帖子回复的直接父消息。

当在 `.content` 中引用事件时，可以使用 `q` 标签与 [NIP-21](21_ZH.md)。

```json
["q", "<事件ID> 或 <事件地址>", "<中继器URL>", "<如果是常规事件的公钥>"]
```

种类 `14` 绝不能被签名。如果被签名，消息可能泄露到中继器并变成**完全公开**。

## 文件消息种类

```jsonc
{
  "id": "<常规哈希>",
  "pubkey": "<发送者公钥>",
  "created_at": "<当前时间>",
  "kind": 15,
  "tags": [
    ["p", "<接收者1公钥>", "<中继器URL>"],
    ["p", "<接收者2公钥>", "<中继器URL>"],
    ["e", "<种类14的ID>", "<中继器URL>", "reply"], // 如果这是回复
    ["subject", "<对话标题>"],
    ["file-type", "<文件MIME类型>"],
    ["encryption-algorithm", "<加密算法>"],
    ["decryption-key", "<解密密钥>"],
    ["decryption-nonce", "<解密随机数>"],
    ["x", "<文件的SHA-256十六进制字符串>"],
    // 其余标签...
  ],
  "content": "<文件URL>"
}
```

种类 `15` 用于发送加密文件事件消息：

- `file-type`：指定附加文件的 MIME 类型（例如，`image/jpeg`、`audio/mpeg` 等）加密前。
- `encryption-algorithm`：指示用于加密文件的加密算法。支持的算法：`aes-gcm`。
- `decryption-key`：接收者用来解密文件的解密密钥。
- `decryption-nonce`：接收者用来解密文件的解密随机数。
- `content`：文件的 URL（`<文件URL>`）。
- `x` 包含加密文件的 SHA-256 十六进制字符串。
- `ox` 包含加密前文件的 SHA-256 十六进制字符串。
- `size`（可选）加密文件的字节大小
- `dim`（可选）像素大小，格式为 `<宽度>x<高度>`
- `blurhash`（可选）在客户端加载文件时显示的 [blurhash](https://github.com/woltapp/blurhash)
- `thumb`（可选）具有相同纵横比的缩略图 URL（使用相同的密钥、随机数加密）
- `fallback`（可选）零个或多个备用文件源，以防 `url` 失败（使用相同的密钥、随机数加密）

就像种类 `14` 一样，种类 `15` 绝不能被签名。

## 聊天室

`pubkey` + `p` 标签的集合定义了一个聊天室。如果添加了新的 `p` 标签或删除了当前的标签，就会创建一个具有清洁消息历史的新房间。

客户端应该在连续线程中渲染同一房间的消息。

可选的 `subject` 标签定义对话的当前名称/主题。任何成员都可以通过简单地向现有的 `pubkey` + `p` 标签房间提交新的 `subject` 来更改主题。不需要在每条消息中发送 `subject`。聊天室中最新的 `subject` 就是对话的主题。

## 加密

遵循 [NIP-59](59_ZH.md)，**未签名的** `kind:14` 和 `kind:15` 聊天消息必须被密封（`kind:13`），然后分别向每个接收者和发送者进行礼品包装（`kind:1059`）。

```js
{
  "id": "<常规哈希>",
  "pubkey": randomPublicKey,
  "created_at": randomTimeUpTo2DaysInThePast(),
  "kind": 1059, // 礼品包装
  "tags": [
    ["p", receiverPublicKey, "<中继器URL>"] // 接收者
  ],
  "content": nip44Encrypt(
    {
      "id": "<常规哈希>",
      "pubkey": senderPublicKey,
      "created_at": randomTimeUpTo2DaysInThePast(),
      "kind": 13, // 密封
      "tags": [], // 无标签
      "content": nip44Encrypt(unsignedKind14, senderPrivateKey, receiverPublicKey),
      "sig": "<由发送者私钥签名>"
    },
    randomPrivateKey, receiverPublicKey
  ),
  "sig": "<由随机私钥签名>"
}
```

加密算法必须使用 [NIP-44](44_ZH.md) 的最新版本。

客户端必须验证 `kind:13` 的公钥是否与 `kind:14` 上的公钥相同，否则任何发送者都可以通过简单地更改 `kind:14` 上的公钥来冒充他人。

客户端应该在密封和礼品包装中将 `created_at` 随机化到过去最多两天，以确保按 `created_at` 分组不会泄露任何元数据。

礼品包装的 `p` 标签可以是接收者的主公钥或为接收直接消息而创建的别名密钥，而不暴露接收者的身份。

客户端可以通过在每个接收者的礼品包装中设置 `expiration` 标签或不向发送者的公钥生成礼品包装来提供消失消息。

## 发布

种类 `10050` 指示用户接收直接消息的首选中继器。事件必须包含带有中继器 URI 的 `relay` 标签列表。

```jsonc
{
  "kind": 10050,
  "tags": [
    ["relay", "wss://inbox.nostr.wine"],
    ["relay", "wss://myrelay.nostr1.com"],
  ],
  "content": "",
  // 其他字段...
}
```

客户端应该将种类 `14` 事件发布到 `10050` 列出的中继器。如果没有找到，这表明用户还没有准备好在此 NIP 下接收消息，客户端不应该尝试。

## 中继器

建议中继器不要向除了在其中标记的客户端之外的其他客户端提供 `kind:1059`。

建议用户选择符合这些做法的中继器。

客户端应该指导用户保持 `kind:10050` 列表较小（1-3 个中继器），并应该将其传播到尽可能多的中继器。

## 优势与局限性

本 NIP 提供以下隐私和安全功能：

1. **无元数据泄露**：参与者身份、每条消息的真实日期和时间、事件种类和其他事件标签都对公众隐藏。仅凭公共信息无法链接发送者和接收者。
2. **无公共群组标识符**：没有公共中央队列、频道或其他聚合标识符来关联或计算同一群组中的所有消息。
3. **无审核**：没有群组管理员：没有邀请或禁令。
4. **无共享秘密**：不需要所有成员都知道可能泄露或被错误共享的秘密
5. **完全可恢复**：任何拥有用户私钥的客户端都可以完全恢复消息
6. **可选前向保密**：用户和客户端可以选择"消失消息"。
7. **使用公共中继器**：消息可以通过公共中继器流动而不会失去隐私。私有中继器可以进一步增加隐私，但不是必需的。
8. **冷存储**：用户可以单方面选择与专门用于直接消息备份和恢复的单独密钥共享他们的消息。

这种方法的主要限制是必须向每个接收者发送单独的加密事件。拥有超过 100 个参与者的群聊应该找到更合适的消息方案。

## 实现

实现此 NIP 的客户端默认应该只连接到在其 `kind:10050` 列表中找到的中继器集合。从中他们应该能够加载所有发送和接收的消息以及获得新的实时更新，使其成为一个非常简单和轻量级的实现，应该很快。

当向任何人发送消息时，客户端必须连接到接收者的 `kind:10050` 中的中继器并在那里发送事件，但可以在之后立即断开连接，除非预期会发送更多消息（例如聊天标签仍然被选中）。客户端还应该向自己的 `kind:10050` 中继器集合发送其传出消息的副本。

## 示例

此示例从 `nsec1w8udu59ydjvedgs3yv5qccshcj8k05fh3l60k9x57asjrqdpa00qkmr89m` 向 `nsec12ywtkplvyq5t6twdqwwygavp5lm4fhuang89c943nf2z92eez43szvn4dt` 发送消息 `Hola, que tal?`。

分别给接收者和发送者的两个最终礼品包装是：

```json
{
   "id":"2886780f7349afc1344047524540ee716f7bdc1b64191699855662330bf235d8",
   "pubkey":"8f8a7ec43b77d25799281207e1a47f7a654755055788f7482653f9c9661c6d51",
   "created_at":1703128320,
   "kind":1059,
   "tags":[
      ["p", "918e2da906df4ccd12c8ac672d8335add131a4cf9d27ce42b3bb3625755f0788"]
   ],
   "content":"AsqzdlMsG304G8h08bE67dhAR1gFTzTckUUyuvndZ8LrGCvwI4pgC3d6hyAK0Wo9gtkLqSr2rT2RyHlE5wRqbCOlQ8WvJEKwqwIJwT5PO3l2RxvGCHDbd1b1o40ZgIVwwLCfOWJ86I5upXe8K5AgpxYTOM1BD+SbgI5jOMA8tgpRoitJedVSvBZsmwAxXM7o7sbOON4MXHzOqOZpALpS2zgBDXSAaYAsTdEM4qqFeik+zTk3+L6NYuftGidqVluicwSGS2viYWr5OiJ1zrj1ERhYSGLpQnPKrqDaDi7R1KrHGFGyLgkJveY/45y0rv9aVIw9IWF11u53cf2CP7akACel2WvZdl1htEwFu/v9cFXD06fNVZjfx3OssKM/uHPE9XvZttQboAvP5UoK6lv9o3d+0GM4/3zP+yO3C0NExz1ZgFmbGFz703YJzM+zpKCOXaZyzPjADXp8qBBeVc5lmJqiCL4solZpxA1865yPigPAZcc9acSUlg23J1dptFK4n3Tl5HfSHP+oZ/QS/SHWbVFCtq7ZMQSRxLgEitfglTNz9P1CnpMwmW/Y4Gm5zdkv0JrdUVrn2UO9ARdHlPsW5ARgDmzaxnJypkfoHXNfxGGXWRk0sKLbz/ipnaQP/eFJv/ibNuSfqL6E4BnN/tHJSHYEaTQ/PdrA2i9laG3vJti3kAl5Ih87ct0w/tzYfp4SRPhEF1zzue9G/16eJEMzwmhQ5Ec7jJVcVGa4RltqnuF8unUu3iSRTQ+/MNNUkK6Mk+YuaJJs6Fjw6tRHuWi57SdKKv7GGkr0zlBUU2Dyo1MwpAqzsCcCTeQSv+8qt4wLf4uhU9Br7F/L0ZY9bFgh6iLDCdB+4iABXyZwT7Ufn762195hrSHcU4Okt0Zns9EeiBOFxnmpXEslYkYBpXw70GmymQfJlFOfoEp93QKCMS2DAEVeI51dJV1e+6t3pCSsQN69Vg6jUCsm1TMxSs2VX4BRbq562+VffchvW2BB4gMjsvHVUSRl8i5/ZSDlfzSPXcSGALLHBRzy+gn0oXXJ/447VHYZJDL3Ig8+QW5oFMgnWYhuwI5QSLEyflUrfSz+Pdwn/5eyjybXKJftePBD9Q+8NQ8zulU5sqvsMeIx/bBUx0fmOXsS3vjqCXW5IjkmSUV7q54GewZqTQBlcx+90xh/LSUxXex7UwZwRnifvyCbZ+zwNTHNb12chYeNjMV7kAIr3cGQv8vlOMM8ajyaZ5KVy7HpSXQjz4PGT2/nXbL5jKt8Lx0erGXsSsazkdoYDG3U",
   "sig":"a3c6ce632b145c0869423c1afaff4a6d764a9b64dedaf15f170b944ead67227518a72e455567ca1c2a0d187832cecbde7ed478395ec4c95dd3e71749ed66c480"
}
```

```json
{
   "id":"162b0611a1911cfcb30f8a5502792b346e535a45658b3a31ae5c178465509721",
   "pubkey":"626be2af274b29ea4816ad672ee452b7cf96bbb4836815a55699ae402183f512",
   "created_at":1702711587,
   "kind":1059,
   "tags":[
      ["p", "44900586091b284416a0c001f677f9c49f7639a55c3f1e2ec130a8e1a7998e1b"]
   ],
   "content":"AsTClTzr0gzXXji7uye5UB6LYrx3HDjWGdkNaBS6BAX9CpHa+Vvtt5oI2xJrmWLen+Fo2NBOFazvl285Gb3HSM82gVycrzx1HUAaQDUG6HI7XBEGqBhQMUNwNMiN2dnilBMFC3Yc8ehCJT/gkbiNKOpwd2rFibMFRMDKai2mq2lBtPJF18oszKOjA+XlOJV8JRbmcAanTbEK5nA/GnG3eGUiUzhiYBoHomj3vztYYxc0QYHOx0WxiHY8dsC6jPsXC7f6k4P+Hv5ZiyTfzvjkSJOckel1lZuE5SfeZ0nduqTlxREGeBJ8amOykgEIKdH2VZBZB+qtOMc7ez9dz4wffGwBDA7912NFS2dPBr6txHNxBUkDZKFbuD5wijvonZDvfWq43tZspO4NutSokZB99uEiRH8NAUdGTiNb25m9JcDhVfdmABqTg5fIwwTwlem5aXIy8b66lmqqz2LBzJtnJDu36bDwkILph3kmvaKPD8qJXmPQ4yGpxIbYSTCohgt2/I0TKJNmqNvSN+IVoUuC7ZOfUV9lOV8Ri0AMfSr2YsdZ9ofV5o82ClZWlWiSWZwy6ypa7CuT1PEGHzywB4CZ5ucpO60Z7hnBQxHLiAQIO/QhiBp1rmrdQZFN6PUEjFDloykoeHe345Yqy9Ke95HIKUCS9yJurD+nZjjgOxZjoFCsB1hQAwINTIS3FbYOibZnQwv8PXvcSOqVZxC9U0+WuagK7IwxzhGZY3vLRrX01oujiRrevB4xbW7Oxi/Agp7CQGlJXCgmRE8Rhm+Vj2s+wc/4VLNZRHDcwtfejogjrjdi8p6nfUyqoQRRPARzRGUnnCbh+LqhigT6gQf3sVilnydMRScEc0/YYNLWnaw9nbyBa7wFBAiGbJwO40k39wj+xT6HTSbSUgFZzopxroO3f/o4+ubx2+IL3fkev22mEN38+dFmYF3zE+hpE7jVxrJpC3EP9PLoFgFPKCuctMnjXmeHoiGs756N5r1Mm1ffZu4H19MSuALJlxQR7VXE/LzxRXDuaB2u9days/6muP6gbGX1ASxbJd/ou8+viHmSC/ioHzNjItVCPaJjDyc6bv+gs1NPCt0qZ69G+JmgHW/PsMMeL4n5bh74g0fJSHqiI9ewEmOG/8bedSREv2XXtKV39STxPweceIOh0k23s3N6+wvuSUAJE7u1LkDo14cobtZ/MCw/QhimYPd1u5HnEJvRhPxz0nVPz0QqL/YQeOkAYk7uzgeb2yPzJ6DBtnTnGDkglekhVzQBFRJdk740LEj6swkJ",
   "sig":"c94e74533b482aa8eeeb54ae72a5303e0b21f62909ca43c8ef06b0357412d6f8a92f96e1a205102753777fd25321a58fba3fb384eee114bd53ce6c06a1c22bab"
}
```
