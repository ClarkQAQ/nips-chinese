NIP-90
======

数据自动售货机
--------------------

`草案` `可选`

此 NIP 定义了客户和服务提供商之间执行按需计算的交互。

钱进去，数据出来。

## 类型
此 NIP 保留范围 `5000-7000` 供数据自动售货机使用。

| 类型      | 描述           |
| ----      | -----------    |
| 5000-5999 | 作业请求类型    |
| 6000-6999 | 作业结果       |
| 7000      | 作业反馈       |

作业结果总是使用比作业请求类型高 `1000` 的类型编号。（例如请求：`kind:5001` 得到结果：`kind:6001`）。

作业请求类型[单独定义](https://github.com/nostr-protocol/data-vending-machines/tree/master/kinds)。

## 理由
Nostr 可以充当数据处理的市场，用户请求以某种方式处理作业（例如，"语音转文本"、"摘要"等），但他们不一定关心"谁"处理数据。

此 NIP 不应与 1:1 市场混淆；相反，它描述了一个流程，其中用户宣布期望的输出、付费意愿，服务提供商竞争以最佳方式满足作业要求。

### 参与者
此 NIP 中描述的工作流程中有两个参与者：
* 客户（请求作业的 npub）
* 服务提供商（完成作业的 npub）

## 作业请求（`kind:5000-5999`）
客户发布的处理数据请求。此事件表示客户有兴趣接收某种计算的结果。

```jsonc
{
    "kind": 5xxx, // 5000-5999 范围内的类型
    "content": "",
    "tags": [
        [ "i", "<data>", "<input-type>", "<relay>", "<marker>" ],
        [ "output", "<mime-type>" ],
        [ "relays", "wss://..." ],
        [ "bid", "<msat-amount>" ],
        [ "t", "bitcoin" ]
    ],
    // 其他字段...
}
```

所有标签都是可选的。

* `i` 标签：作业的输入数据（零个或多个输入）
    * `<data>`：输入的参数
    * `<input-type>`：应该如何解释此参数。必须是以下之一：
        * `url`：要获取应处理数据的 URL。
        * `event`：Nostr 事件 ID。
        * `job`：具有指定事件 ID 的先前作业的输出。确定要构建哪个输出的决定权在服务提供商（例如等待客户的信号、等待付款等）
        * `text`：`<data>` 是输入的值，不需要解析
    * `<relay>`：如果 `event` 或 `job` 输入类型，发布事件/作业的中继器，否则可选或空字符串
    * `<marker>`：可选字段，指示此输入应该如何在作业上下文中使用
* `output`：预期输出格式。不同的作业请求 `kind` 更精确地定义了这一点。
* `param`：作业的可选参数，作为键（第一个参数）/值（第二个参数）。不同的作业请求 `kind` 更精确地定义了这一点。（例如 `[ "param", "lang", "es" ]`）
* `bid`：客户可以指定他们愿意支付的最大金额（以毫聪为单位）
* `relays`：服务提供商应该发布响应的中继器列表
* `p`：客户感兴趣的服务提供商。其他 SP 仍可能选择处理作业

### 加密参数

如果用户想要保持输入参数秘密，他们可以使用服务提供商的 'p' 标签加密 `i` 和 `param` 标签并将其添加到内容字段。添加标签 `encrypted` 作为标签。私有标签的加密将使用 [NIP-04 - 加密直接消息加密](04.md)，使用用户的私钥和服务提供商的公钥作为共享密钥

```json
[
  ["i", "法国的首都是什么？", "text"],
  ["param", "model", "LLaMA-2"],
  ["param", "max_tokens", "512"],
  ["param", "temperature", "0.5"],
  ["param", "top-k", "50"],
  ["param", "top-p", "0.7"],
  ["param", "frequency_penalty", "1"]
]
```

此参数数据将被加密并添加到 `content` 字段，并且应该存在 `p` 标签

```jsonc
{
  "content": "BE2Y4xvS6HIY7TozIgbEl3sAHkdZoXyLRRkZv4fLPh3R7LtviLKAJM5qpkC7D6VtMbgIt4iNcMpLtpo...",
  "tags": [
    ["p", "04f74530a6ede6b24731b976b8e78fb449ea61f40ff10e3d869a3030c4edc91f"],
    ["encrypted"]
  ],
  // 其他字段...
}
```


## 作业结果（`kind:6000-6999`）

服务提供商发布作业结果，提供作业结果的输出。他们应该标记原始作业请求事件 id 以及客户的公钥。

```jsonc
{
  "pubkey": "<服务提供商公钥>",
  "content": "<载荷>",
  "kind": 6xxx,
  "tags": [
    ["request", "<作业请求>"],
    ["e", "<作业请求ID>", "<中继提示>"],
    ["i", "<输入数据>"],
    ["p", "<客户公钥>"],
    ["amount", "请求付款金额", "<可选bolt11>"]
  ],
  // 其他字段...
}
```

* `request`：作业请求事件字符串化 JSON。
* `amount`：服务提供商请求支付的毫聪。可选的第三个值可以是 bolt11 发票。
* `i`：请求中指定的原始输入。

### 加密输出

如果请求有加密参数，则输出应该加密并放置在 `content` 字段中。如果输出已加密，则避免包含带有明文输入数据的 `i` 标签。
添加标签 encrypted 以将输出内容标记为 `encrypted`

```jsonc
{
  "pubkey": "<服务提供商公钥>",
  "content": "<加密载荷>",
  "kind": 6xxx,
  "tags": [
    ["request", "<作业请求>"],
    ["e", "<作业请求ID>", "<中继提示>"],
    ["p", "<客户公钥>"],
    ["amount", "请求付款金额", "<可选bolt11>"],
    ["encrypted"]
  ],
  // 其他字段...
}
```

## 作业反馈

服务提供商可以向客户提供关于作业的反馈。

```jsonc
{
  "kind": 7000,
  "content": "<空或载荷>",
  "tags": [
    ["status", "<状态>", "<额外信息>"],
    ["amount", "请求付款金额", "<bolt11>"],
    ["e", "<作业请求ID>", "<中继提示>"],
    ["p", "<客户公钥>"],
  ],
  // 其他字段...
}
```

* `content`：空或作业结果（例如用于部分结果样本）
* `amount` 标签：如[作业结果](#作业结果kind6000-6999)部分中定义。
* `status` 标签：服务提供商应该指示此反馈状态指的是什么。[作业反馈状态](#作业反馈状态)定义状态。可以添加额外的人类可读信息作为额外参数。

* 注意：如果输入参数需要输入加密，则 `content` 字段将有加密载荷，`p` 标签作为键。

### 作业反馈状态

| 状态             | 描述                                                                                                 |
| --------         | -------------                                                                                        |
| `payment-required` | 服务提供商需要付款才能继续。                                                                          |
| `processing`       | 服务提供商正在处理作业。                                                                              |
| `error`            | 服务提供商无法处理作业。                                                                              |
| `success`          | 服务提供商成功处理了作业。                                                                            |
| `partial`          | 服务提供商部分处理了作业。`.content` 可能包含部分结果的样本。                                           |

任何作业反馈事件可能在 `.content` 字段中包含结果，如[作业结果](#作业结果kind6000-6999)部分中所述。这对服务提供商提供到目前为止已处理结果的样本很有用。


## 协议流程

* 客户发布作业请求（例如 `kind:5000` 语音转文本）。
* 服务提供商可以提交 `kind:7000` 作业反馈事件（例如 `payment-required`、`processing`、`error` 等）。
* 完成后，服务提供商发布带有 `kind:6000` 作业结果事件的作业结果。
* 在任何时候，如果有 `amount` 待支付，如服务提供商指示的，用户可以支付包含的 `bolt11` 或向服务提供商发送给用户的作业结果事件发送 zap。

作业反馈（`kind:7000`）和作业结果（`kind:6000-6999`）事件可能包含 `amount` 标签，这可以解释为付费建议。服务提供商必须使用 `payment-required` 反馈事件来表示需要付款，并且在发送付款之前不会执行进一步操作。

客户总是可以支付包含的 `bolt11` 发票或向请求付款的事件发送 zap，如果他们选择包含 bolt11 发票，服务提供商应该监控两者。

### 关于协议流程的说明
流程故意模糊，允许客户和服务提供商之间的交互具有巨大的灵活性，以便服务提供商可以根据自己的决策/风险感知来建模他们的行为。

一些服务提供商可能选择在发送 `processing` 或交付结果之前提交 `payment-required` 作为第一个反应，一些可能选择为作业提供部分结果（例如样本），发送 `payment-required` 来交付其余结果，一些服务提供商可能选择根据 npub 的过去行为评估付款的可能性，从而在请求付款之前提供作业结果以获得最佳 UX。

此 NIP 不定义个别自动售货机应该如何选择经营其业务。

## 取消
作业请求可能通过发布标记作业请求事件的 `kind:5` 删除请求事件来取消。

## 附录 1：作业链
客户可以请求多个作业作为链处理，其中一个作业的输出是另一个作业的输入。（例如播客转录 -> 转录摘要）。这通过指定具有 `job` 类型的不同作业的事件 id 作为输入来完成。

服务提供商可能在看到先前作业的结果时立即开始处理后续作业，但他们可能会等待首先发布 zap。这引入了作业 #1 的服务提供商可能延迟发布 zap 事件以获得优势的风险。这种风险由服务提供商减轻或决定作业 #1 的服务提供商是否倾向于有足够好的结果，以至于不等待明确的 zap 来假设作业被接受。

这为服务提供商提供了更高水平的灵活性（复杂的服务提供商无论如何都会采用）。

## 附录 2：服务提供商可发现性
服务提供商可以使用 NIP-89 公告来宣传他们对作业类型的支持：

```jsonc
{
  "kind": 31990,
  "pubkey": "<公钥>",
  "content": "{
    \"name\": \"翻译 DVM\",
    \"about\": \"我是专门翻译比特币内容的 DVM。\"
  }",
  "tags": [
    ["k", "5005"], // 例如翻译
    ["t", "bitcoin"] // 例如可选地宣传它专门从事比特币音频转录，不会将"Drivechains"与"Ridechains"混淆
  ],
  // 其他字段...
}
```

客户可以使用 NIP-89 查看他们关注的人使用哪些服务提供商。
