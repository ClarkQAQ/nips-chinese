NIP-42
======

客户端到中继器的身份验证
-----------------------------------

`草案` `可选`

本 NIP 定义了一种客户端通过签署临时事件来向中继器进行身份验证的方法。

## 动机

中继器可能希望要求客户端进行身份验证以访问受限资源。例如，

  - 中继器可能要求付费或其他形式的白名单来发布事件——这可以通过简单地限制发布由白名单密钥签署的事件来实现，但使用此 NIP，它们可以选择接受任何事件，只要它们是从经过身份验证的用户发布的；
  - 中继器可能将对 `kind: 4` 直接消息的访问限制为仅参与聊天交换的各方，为此它可能在客户端可以查询该种类之前要求身份验证。
  - 中继器可能将任何种类的订阅限制为付费用户或通过任何其他方式列入白名单的用户，并要求身份验证。

## 定义

### 新的客户端-中继器协议消息

本 NIP 定义了一个新消息 `AUTH`，当中继器支持身份验证时可以发送，客户端希望向中继器进行身份验证时可以发送。当由中继器发送时，消息具有以下形式：

```
["AUTH", <挑战字符串>]
```

当由客户端发送时，具有以下形式：

```
["AUTH", <签名事件JSON>]
```

客户端可以在一系列 `AUTH` 消息中提供来自多个公钥的签名事件。中继器必须相应地将所有公钥视为已认证。

客户端发送的 `AUTH` 消息必须用 `OK` 消息回答，就像任何 `EVENT` 消息一样。

### 规范身份验证事件

签名事件是一个不打算发布或查询的临时事件，它必须是 `kind: 22242`，并且应该至少有两个标签，一个用于中继器 URL，一个用于从中继器接收的挑战字符串。中继器必须排除 `kind: 22242` 事件被广播给任何客户端。`created_at` 应该是当前时间。示例：

```jsonc
{
  "kind": 22242,
  "tags": [
    ["relay", "wss://relay.example.com/"],
    ["challenge", "challengestringhere"]
  ],
  // 其他字段...
}
```

### `OK` 和 `CLOSED` 机器可读前缀

本 NIP 定义了两个新前缀，可以在 `OK`（响应客户端事件写入）和 `CLOSED`（响应客户端被拒绝的订阅）中使用：

- `"auth-required: "` - 当客户端尚未执行 `AUTH` 而中继器要求这样做以满足查询或写入事件时。
- `"restricted: "` - 当客户端已经执行了 `AUTH` 但用于执行它的密钥仍然不被中继器允许或超出其授权时。

## 协议流程

中继器可以在任何时候向客户端发送包含挑战的 `AUTH` 消息。挑战在连接期间有效，或直到中继器发送另一个挑战。客户端可以决定在任何时候发送其 `AUTH` 事件，认证会话在连接期间之后有效。

### 响应 `REQ` 消息的 `auth-required`

鉴于中继器可能只要求客户端对某些工作执行身份验证，如回答 `REQ` 或接受 `EVENT` 写入，这些是一些预期的常见流程：

```
relay: ["AUTH", "<挑战>"]
client: ["REQ", "sub_1", {"kinds": [4]}]
relay: ["CLOSED", "sub_1", "auth-required: we can't serve DMs to unauthenticated users"]
client: ["AUTH", {"id": "abcdef...", ...}]
client: ["AUTH", {"id": "abcde2...", ...}]
relay: ["OK", "abcdef...", true, ""]
relay: ["OK", "abcde2...", true, ""]
client: ["REQ", "sub_1", {"kinds": [4]}]
relay: ["EVENT", "sub_1", {...}]
relay: ["EVENT", "sub_1", {...}]
relay: ["EVENT", "sub_1", {...}]
relay: ["EVENT", "sub_1", {...}]
...
```

在这种情况下，来自中继器的 `AUTH` 消息可以在客户端连接时立即发送，或者可以在发送 `CLOSED` 之前立即发送。唯一的要求是_客户端必须有一个与该中继器关联的存储挑战_，以便它可以响应 `auth-required` `CLOSED` 消息。

### 响应 `EVENT` 消息的 `auth-required`

当客户端想要向中继器写入 `EVENT` 时，相同的流程有效，除了现在中继器发送回 `OK` 消息而不是 `CLOSED` 消息：

```
relay: ["AUTH", "<挑战>"]
client: ["EVENT", {"id": "012345...", ...}]
relay: ["OK", "012345...", false, "auth-required: we only accept events from registered users"]
client: ["AUTH", {"id": "abcdef...", ...}]
relay: ["OK", "abcdef...", true, ""]
client: ["EVENT", {"id": "012345...", ...}]
relay: ["OK", "012345...", true, ""]
```

## 签名事件验证

要验证 `AUTH` 消息，中继器必须确保：

  - `kind` 是 `22242`；
  - 事件 `created_at` 接近（例如在当前时间的约 10 分钟内）；
  - `"challenge"` 标签匹配之前发送的挑战；
  - `"relay"` 标签匹配中继器 URL：
    - 可以应用 URL 标准化技术。对于大多数情况，只检查域名是否正确应该就足够了。
