NIP-53
======

实时活动
---------------

`草案` `可选`

本 NIP 引入了事件种类来宣传实时空间和公钥在其中的参与。

## 直播流

一种特殊的 `kind:30311` "直播流事件" 被定义为_可寻址事件_，其标签宣传直播流的内容和参与者。

每个 `p` 标签应该有一个用户在事件中当前角色的**可显示**标记名称（例如 `Host`、`Speaker`、`Participant`），中继器信息可能为空。此事件将随着参与者加入和离开活动而不断更新。

例如：

```jsonc
{
  "kind": 30311,
  "tags": [
    ["d", "<唯一标识符>"],
    ["title", "<事件名称>"],
    ["summary", "<描述>"],
    ["image", "<预览图像 URL>"],
    ["t", "标签"]
    ["streaming", "<URL>"],
    ["recording", "<URL>"], // 用于在活动结束后放置编辑的视频
    ["starts", "<以秒为单位的 unix 时间戳>"],
    ["ends", "<以秒为单位的 unix 时间戳>"],
    ["status", "<planned, live, ended>"],
    ["current_participants", "<数量>"],
    ["total_participants", "<数量>"],
    ["p", "91cf9..4e5ca", "wss://provider1.com/", "主持人", "<证明>"],
    ["p", "14aeb..8dad4", "wss://provider2.com/nostr", "发言人"],
    ["p", "612ae..e610f", "ws://provider3.com/ws", "参与者"],
    ["relays", "wss://one.com", "wss://two.com", /*...*/],
    ["pinned", "<置顶直播聊天消息的事件 ID>"],
  ],
  "content": "",
  // 其他字段...
}
```

每个活动都应使用不同的 `d` 标签。所有其他标签都是可选的。

提供者应该保持参与者列表较小（例如少于 1000 用户），当达到限制时，提供者应该选择哪些参与者在事件中被命名。客户端不应期望完整的列表。活动结束后，事件可以被删除或更新以总结活动并提供异步内容（例如事件录制）。

客户端预期订阅一般的 `kind:30311` 事件或给定关注列表和状态。客户端可以显示参与者在活动中的角色以及加入活动的访问点。

实时活动管理客户端预期在事件期间不断更新 `kind:30311`。客户端可以选择将超过 1 小时没有任何更新的 `status=live` 事件视为 `ended`。当状态改变为 `live` 和从 `live` 改变时，`starts` 和 `ends` 时间戳应该被更新。

活动必须使用 [NIP-19](19_ZH.md) `naddr` 代码和 `a` 标签链接。

### 参与同意证明

事件所有者可以在每个 `p` 标签中添加证明作为第 5 项，以澄清参与者同意加入事件。证明是每个 `p` 的私钥对事件完整 `a` 标签（`kind:pubkey:dTag`）的 SHA256 签名，用十六进制编码。

客户端可以只在证明可用时显示参与者，或者如果证明不可用则将参与者显示为"受邀"。

此功能对于避免恶意事件所有者在大账户持有者不知情的情况下将他们添加到事件中，以引诱他们的关注者进入恶意所有者的陷阱是重要的。

### 直播聊天消息

事件 `kind:1311` 是直播聊天的频道消息。客户端必须包含活动的 `a` 标签。`e` 标签表示此帖子回复的直接父消息。

```jsonc
{
  "kind": 1311,
  "tags": [
    ["a", "30311:<社区事件作者公钥>:<社区的 d 标识符>", "<可选中继器 URL>"],
  ],
  "content": "对直播流的打赏很棒。",
  // 其他字段...
}
```

当使用 [NIP-21](21_ZH.md) 在 `.content` 中引用事件时，可以使用 `q` 标签。

```json
["q", "<事件 ID> 或 <事件地址>", "<中继器 URL>", "<如果是常规事件则为公钥>"]
```

主持人可以通过更新直播事件 kind `30311` 中的 `pinned` 标签来选择置顶一个或多个直播聊天消息。

### 示例

#### 直播流

```json
{
  "id": "57f28dbc264990e2c61e80a883862f7c114019804208b14da0bff81371e484d2",
  "pubkey": "1597246ac22f7d1375041054f2a4986bd971d8d196d7997e48973263ac9879ec",
  "created_at": 1687182672,
  "kind": 30311,
  "tags": [
    ["d", "demo-cf-stream"],
    ["title", "Adult Swim Metalocalypse"],
    ["summary", "来自 IPTV-ORG 收藏的直播流"],
    ["streaming", "https://adultswim-vodlive.cdn.turner.com/live/metalocalypse/stream.m3u8"],
    ["starts", "1687182672"],
    ["status", "live"],
    ["t", "动画"],
    ["t", "iptv"],
    ["image", "https://i.imgur.com/CaKq6Mt.png"]
  ],
  "content": "",
  "sig": "5bc7a60f5688effa5287244a24768cbe0dcd854436090abc3bef172f7f5db1410af4277508dbafc4f70a754a891c90ce3b966a7bc47e7c1eb71ff57640f3d389"
}
```

#### 直播流聊天消息

```json
{
  "id": "97aa81798ee6c5637f7b21a411f89e10244e195aa91cb341bf49f718e36c8188",
  "pubkey": "3f770d65d3a764a9c5cb503ae123e62ec7598ad035d836e2a810f3877a745b24",
  "created_at": 1687286726,
  "kind": 1311,
  "tags": [
    ["a", "30311:1597246ac22f7d1375041054f2a4986bd971d8d196d7997e48973263ac9879ec:demo-cf-stream", "", "root"]
  ],
  "content": "对直播流的打赏很棒。",
  "sig": "997f62ddfc0827c121043074d50cfce7a528e978c575722748629a4137c45b75bdbc84170bedc723ef0a5a4c3daebf1fef2e93f5e2ddb98e5d685d022c30b622"
}
```

## 会议空间

会议空间包含一个或多个视频/音频房间，用户可以加入并参与流媒体。

### 会议空间事件（kind:30312）

一种特殊的 `kind:30312` "空间主机" 事件定义了虚拟交互空间的配置和属性。每个空间都有唯一标识符，可以托管多个事件/会议。

```jsonc
{
  "kind": 30312,
  "tags": [
    ["d", "<唯一标识符>"],              // 必需：房间标识符
    ["room", "<房间名称>"],            // 必需：显示名称
    ["summary", "<描述>"],              // 可选：房间描述
    ["image", "<预览图像 URL>"],          // 可选：房间图像
    ["status", "<open, private, closed>"],     // 必需：房间可访问性
    ["service", "<URL>"],                      // 必需：访问房间的 URL
    ["endpoint", "<URL>"],                     // 可选：状态/信息的 API 端点
    ["t", "<标签>"],                        // 可选：允许多个标签
    ["p", "<公钥>", "<URL>", "<角色>", "<证明>"],  // 必需：至少一个提供者
    ["relays", "<URL>", "<URL>", /*...*/]     // 可选：首选中继器
  ],
  "content": ""  // 通常为空，可能包含额外元数据
}
```

空间属性：
* 必须是开放、私有或关闭之一。关闭意味着房间不在运行。
* 可以为私有房间指定访问控制策略（例如仅邀请、需要付费）
* 不使用时可以持续存在
* 必须至少有一个具有"主机"角色的提供者
* 可以有具有不同角色的多个提供者

提供者角色（p 标签）：
* 主机：完整的房间管理能力
* 版主：房间版主能力
* 发言人：允许展示/发言
* 可选证明字段用于角色验证

### 会议室事件（kind:30313）

一种特殊的 kind:30313 事件表示房间内的预定或正在进行的会议。它必须使用 d 标签引用其父房间。

```jsonc
{
  "kind": 30313,
  "tags": [
    ["d", "<事件唯一标识符>"],        // 必需：事件标识符
    ["a", "30312:<公钥>:<房间 ID>", "wss://nostr.example.com"], // 必需：对父空间的引用，来自 30312 的 'd'
    ["title", "<会议标题>"],              // 必需：会议标题
    ["summary", "<描述>"],              // 可选：会议描述
    ["image", "<预览图像 URL>"],          // 可选：会议图像
    ["starts", "<unix 时间戳>"],            // 必需：开始时间
    ["ends", "<unix 时间戳>"],              // 可选：结束时间
    ["status", "<planned, live, ended>"],      // 必需：会议状态
    ["total_participants", "<数量>"],        // 可选：总注册数
    ["current_participants", "<数量>"],      // 可选：当前活跃数
    ["p", "<公钥>", "<URL>", "<角色>"],     // 可选：具有角色的参与者
  ],
  "content": ""  // 通常为空，可能包含额外元数据
}
```

事件属性：
* 必须通过 d 标签引用父房间
* 必须有状态（planned/live/ended）
* 必须有开始时间
* 可以跟踪参与者计数
* 可以包含特定于事件的参与者角色

事件管理：
* 客户端应该在直播时定期更新事件状态
* 1 小时内没有更新的事件可以被视为已结束
* 当状态改变时应该更新 starts 和 ends 时间戳

### 示例

#### 会议空间（kind:30312）

```jsonc
{
  "kind": 30312,
  "tags": [
    ["d", "main-conference-room"],
    ["room", "主会议厅"],
    ["summary", "我们的主要会议空间"],
    ["image", "https://example.com/room.jpg"],
    ["status", "open"],
    ["service", "https://meet.example.com/room"],
    ["endpoint", "https://api.example.com/room"],
    ["t", "会议"],
    ["p", "f7234bd4c1394dda46d09f35bd384dd30cc552ad5541990f98844fb06676e9ca", "wss://nostr.example.com/", "所有者"],
    ["p", "14aeb..8dad4", "wss://provider2.com/", "版主"],
    ["relays", "wss://relay1.com", "wss://relay2.com"]
  ],
  "content": ""
}
```

#### 会议室（kind:30313）

```jsonc
{
  "kind": 30313,
  "tags": [
    ["d", "annual-meeting-2025"],
    ["a", "30312:f7234bd4c1394dda46d09f35bd384dd30cc552ad5541990f98844fb06676e9ca:main-conference-room", "wss://nostr.example.com"]
    ["title", "2025 年度公司会议"],
    ["summary", "年度全公司会议"],
    ["image", "https://example.com/meeting.jpg"],
    ["starts", "1676262123"],
    ["ends", "1676269323"],
    ["status", "live"],
    ["total_participants", "180"],
    ["current_participants", "175"],
    ["p", "91cf9..4e5ca", "wss://provider1.com/", "发言人"],
  ],
  "content": ""
}
```

### 房间在场

新的 `kind: 10312` 提供了一个表示听众在场的事件。

在场事件应该定期更新，客户端应该过滤早于给定时间窗口的在场事件。

**此 kind `10312` 是常规可替换事件，因此在场只能在一个房间内同时表示。**

```json
{
  "kind": 10312,
  "tags": [
    ["a" , "<房间 a 标签>", "<中继器提示>", "root"],
    ["hand", "1"] // 举手标志
  ]
}
```
