NIP-45
======

事件计数
------------

`草案` `可选`

中继器可以支持动词 `COUNT`，它提供了获取事件计数的机制。

## 动机

客户端可能想要对连接的中继器执行的一些查询代价高昂，例如，为了检索给定公钥的关注者计数，客户端必须查询引用给定公钥的所有 kind-3 事件，仅仅为了计算它们。结果可能被客户端或单独的索引服务器缓存作为替代，但这两种选择都通过在 Nostr 之上创建第二层协议来侵蚀网络的去中心化。

## 过滤器和返回值

本 NIP 定义了动词 `COUNT`，它接受订阅 ID 和在 [NIP 01](01_ZH.md) 中为动词 `REQ` 指定的过滤器。多个过滤器通过 OR 连接并聚合为单个计数结果。

```
["COUNT", <订阅ID>, <过滤器JSON>...]
```

计数使用 `{"count": <整数>}` 形式的 `COUNT` 响应返回。中继器可以使用概率计数来减少计算需求。
如果中继器使用概率计数，它可以在响应中用 `approximate` 键指示，即 `{"count": <整数>, "approximate": <true|false>}`。

```
["COUNT", <订阅ID>, {"count": <整数>}]
```

每当中继器决定拒绝满足 `COUNT` 请求时，它必须返回 `CLOSED` 消息。

## 示例

### 关注者计数

```
["COUNT", <订阅ID>, {"kinds": [3], "#p": [<公钥>]}]
["COUNT", <订阅ID>, {"count": 238}]
```

### 计算帖子和反应

```
["COUNT", <订阅ID>, {"kinds": [1, 7], "authors": [<公钥>]}]
["COUNT", <订阅ID>, {"count": 5}]
```

### 大约计算帖子

```
["COUNT", <订阅ID>, {"kinds": [1]}]
["COUNT", <订阅ID>, {"count": 93412452, "approximate": true}]
```

### 中继器拒绝计数

```
["COUNT", <订阅ID>, {"kinds": [4], "authors": [<公钥>], "#p": [<公钥>]}]
["CLOSED", <订阅ID>, "auth-required: cannot count other people's DMs"]
```
