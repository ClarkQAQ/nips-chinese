NIP-29
======

基于中继器的群组
------------------

`草案` `可选`

此 NIP 定义了一个标准，用于只有封闭用户集合可写的群组。它们可以对外部用户公开阅读，也可以不公开。

群组由任意长度的随机字符串标识，作为 _id_。

没有创建群组的方法，实际发生的是中继器（最可能在用户要求时）会围绕一些特定 id 创建规则，以便这些 id 可以作为实际群组，因此发送到该群组的消息将受到这些规则的约束。

通常，群组最初属于一个特定的中继器，但社区可以选择将群组移动到其他中继器，甚至分叉群组，使其在不同中继器上以不同形式存在——仍使用相同的 _id_。

## 中继器生成的事件

中继器应该生成描述群组元数据和群组管理员的事件。这些是由中继器密钥对直接签名的 _可寻址_ 事件，以群组 _id_ 作为 `d` 标签。

## 群组标识符

群组可以由格式为 `<host>'<group-id>` 的字符串标识。例如，在中继器 `wss://groups.nostr.com` 托管的 _id_ 为 `abcdef` 的群组将由字符串 `groups.nostr.com'abcdef` 标识。

群组标识符必须是限制为字符 `a-z0-9-_` 的字符串，并且应该是随机的以避免名称冲突。

当遇到仅有 `<host>` 而没有 `'<group-id>` 时，客户端可以推断 `_` 为群组 id，这是一个专用于中继器本地讨论的特殊顶级群组。

## `h` 标签

用户发送到群组的事件（聊天消息、文本笔记、审核事件等）必须有一个值设置为群组 _id_ 的 `h` 标签。

## 时间线引用

为了不被脱离上下文使用，发送到这些群组的事件可能包含对在 `previous` 标签中从同一中继器看到的先前事件的引用。选择哪些先前事件的选择权属于客户端。引用应该使用用户在中继器中看到的最后 50 个事件中任何事件的前 8 个字符（4 字节）进行，不包括他们自己的事件。可以有任意数量的引用（包括零），但建议客户端至少包含 3 个，中继器强制执行此要求。

这是一个防止消息被广播到具有群组分叉的外部中继器而脱离上下文的技巧。中继器应该拒绝包含对其自己数据库中找不到的事件的时间线引用的任何事件。客户端也应该检查这些以保持中继器的诚实。

## 延迟发布

中继器应该防止延迟发布（现在发布的消息带有几天甚至几小时前的时间戳），除非它们开放接收从另一个中继器分叉或移动的群组。

## 群组管理

群组可以有任意数量具有提升访问权限的用户。这些用户由中继器任意定义的角色标签标识（另见 `kind:39003` 的描述）。每个角色能够做什么在此 NIP 中也没有定义，这是一个可以变化的中继器策略。角色可以由其他用户分配（只要他们有添加角色的能力），通过发布 `kind:9000` 事件，在 `p` 标签中包含该用户的公钥，然后是角色（即使用户已经是群组成员，也可以发布 `kind:9000`，用户角色必须只是更新）。

群组支持的角色如果分配了一些特殊权限，应该可以在事件 `kind:39003` 上访问，但中继器也可以接受其他角色名称，由客户端任意定义，只是不对它们做任何事情。

拥有任何具有任何权限的角色的用户可以在广义上被视为 _管理员_，并在群组的 `kind:39001` 事件中返回。

## 非托管群组

非托管群组是可以在任何不了解 NIP-29 细节的公共中继器中使用的临时群组。它们依赖于中继器的自然白/黑名单（或缺乏），但除此之外不会被主动管理，不会有任何管理员、群组状态或元数据事件。

在 `非托管` 群组中，每个人都被认为是成员。

非托管群组可以过渡到托管群组，在这种情况下，中继器主密钥只需发布审核事件设置所有群组的状态并开始执行他们选择的规则。

## 事件定义

这些是预期在 NIP-29 群组中找到的事件。

### 普通用户创建的事件

群组可以接受任何事件类型，包括聊天、线程、长格式文章、日历、直播、市场公告等。这些应该按照各自 NIP 中的定义，并添加 `h` 标签。

### 与用户相关的群组管理事件

这些是用户可以发送来管理他们在群组中的情况的事件，它们也需要 `h` 标签。

- *加入请求* (`kind:9021`)

任何用户都可以向中继器发送类型 `9021` 事件以请求加入群组。如果用户尚未添加到群组，中继器必须拒绝请求。伴随的错误消息应该说明拒绝是否是最终的，请求是否正在等待审核，或者是否有其他特殊处理相关（例如，如果需要付款）。如果用户已经是成员，事件必须被拒绝，错误消息前缀为 `duplicate: `。

```json
{
  "kind": 9021,
  "content": "可选原因",
  "tags": [
    ["h", "<群组ID>"],
    ["code", "<可选邀请码>"]
  ]
}
```

可选的 `code` 标签可以被中继器用于在 `封闭` 群组中与 `kind:9009` `create-invite` 审核事件一起预授权接受。

- *离开请求* (`kind:9022`)

任何用户都可以向中继器发送这些事件之一以自动从群组中移除。中继器将自动发布 `kind:9001` 响应移除此用户。

```json
{
  "kind": 9022,
  "content": "可选原因",
  "tags": [
    ["h", "<群组ID>"]
  ]
}
```

### 群组状态——或审核

这些是预期由中继器主密钥或群组管理员发送的事件——如果它们不来自授权管理员，中继器应该拒绝它们。它们也需要 `h` 标签。

- *审核事件* (`kinds:9000-9020`) (可选)

客户端可以向中继器发送这些事件以完成审核操作。中继器必须基于其角色和中继器的内部策略检查发送事件的公钥是否能够执行给定操作（另见 `kind:39003` 的描述）。

```jsonc
{
  "kind": 90xx,
  "content": "可选原因",
  "tags": [
    ["h", "<群组ID>"],
    ["previous", /*...*/]
  ]
}
```

每个审核操作使用不同的类型并需要不同的参数，这些参数作为标签给出。这些在以下表格中定义：

| kind | name                | tags                                           |
| ---  | ---                 | ---                                            |
| 9000 | `put-user`          | `p` 带公钥十六进制和可选角色                      |
| 9001 | `remove-user`       | `p` 带公钥十六进制                               |
| 9002 | `edit-metadata`     | 来自 `kind:39000` 的要修改字段                   |
| 9005 | `delete-event`      | `e` 带事件 id 十六进制                           |
| 9007 | `create-group`      |                                                |
| 9008 | `delete-group`      |                                                |
| 9009 | `create-invite`     |                                                |

预期群组状态（谁是允许的成员，谁是管理员以及具有哪些权限，群组名称和图片是什么等）可以从这些事件的规范序列完全重构。

### 群组元数据事件

这些事件在 `d` 标签中包含群组 id，而不是 `h` 标签。它们必须仅由中继器主密钥创建，每个群组应该始终存在每种事件的单个实例（或无）。它们仅仅是信息性的，但应该反映最新的群组状态（随着时间推移通过审核事件改变）。

- *群组元数据* (`kind:39000`) (可选)

此事件定义群组的元数据——基本上是客户端应该如何显示它。它必须由找到它的中继器生成和签名。如果由其他人签名，中继器不应该接受这些事件。

如果群组被分叉并托管在多个中继器中，每个不同的中继器将有此事件的多个版本，依此类推。

当找不到此事件时，客户端仍可以连接到群组，但将其视为具有不同状态，`非托管`，

```jsonc
{
  "kind": 39000,
  "content": "",
  "tags": [
    ["d", "<群组ID>"],
    ["name", "披萨爱好者"],
    ["picture", "https://pizza.com/pizza.png"],
    ["about", "一个为爱披萨的人准备的群组"],
    ["public"], // 或 ["private"]
    ["open"] // 或 ["closed"]
  ]
  // 其他字段...
}
```

`name`、`picture` 和 `about` 是用于显示目的的群组基本元数据。`public` 表示群组可以被任何人 _阅读_，而 `private` 表示只有经过身份验证的用户可以阅读。`open` 表示任何人都可以请求加入并且请求将被自动批准，而 `closed` 表示成员必须预先批准或加入请求将被手动处理。

- *群组管理员* (`kind:39001`) (可选)

每个管理员都与一个或多个角色一起列出。这些角色应该与中继器支持的角色相对应，如 `kind:39003` 事件所宣传的。

```jsonc
{
  "kind": 39001,
  "content": "披萨爱好者群组的管理员列表",
  "tags": [
    ["d", "<群组ID>"],
    ["p", "<公钥1十六进制>", "ceo"],
    ["p", "<公钥2十六进制>", "secretary", "gardener"],
    // 其他公钥...
  ],
  // 其他字段...
}
```

- *群组成员* (`kind:39002`) (可选)

这是群组成员的公钥列表。中继器可能选择不发布此信息，限制哪些公钥可以获取它，或者只显示其中成员的子集。

客户端不应该假设这总是存在或包含完整的成员列表。

```jsonc
{
  "kind": 39002,
  "content": "披萨爱好者群组的成员列表",
  "tags": [
    ["d", "<群组ID>"],
    ["p", "<管理员1>"],
    ["p", "<成员公钥1>"],
    ["p", "<成员公钥2>"],
    // 其他公钥...
  ],
  // 其他字段...
}
```

- *群组角色* (`kind:39003`) (可选)

这是一个可能由中继器发布的事件，告知用户和客户端此中继器根据其内部逻辑支持哪些角色。

例如，中继器可能选择支持角色 `"admin"` 和 `"moderator"`，其中 `"admin"` 将被允许编辑群组元数据、删除消息和从群组中移除用户，而 `"moderator"` 只能删除消息（或者中继器可能选择称这些角色为 `"ceo"` 和 `"secretary"`，确切的角色名称不相关）。

中继器决定支持哪些角色以及如何基于它们在内部处理审核事件的过程是特定于每个中继器的，此处未指定。

```jsonc
{
  "kind": 39003,
  "content": "此群组支持的角色列表",
  "tags": [
    ["d", "<群组ID>"],
    ["role", "<角色名称>", "<可选描述>"],
    ["role", "<角色名称>", "<可选描述>"],
    // 其他角色...
  ],
  // 其他字段...
}
```

## 实现细节

### 检查您在群组中的成员身份

群组中存在的最新的 `kind:9000` 或 `kind:9001` 事件应该告诉用户他们当前是群组成员还是被移除了。如果这些都不存在，假设用户不是群组成员——除非群组是 `非托管` 的，在这种情况下假设用户是成员。

### 将自己添加到群组

当群组是 `开放` 的时，任何人都可以向其发送 `kind:9021` 事件以被添加，然后期望发出 `kind:9000` 事件确认用户已被添加。`封闭` 群组也是如此，除了在这种情况下，用户只有在有邀请码时才能发送 `kind:9021`。

### 存储您的群组列表

[NIP-51](51.md) 中包含了 `kind:10009` 的定义，允许客户端存储用户想要记住的群组列表。

### 使用 `非托管` 中继器

为了防止事件泄漏，当使用 `非托管` 中继器时，客户端应该包含 [NIP-70](70.md) `-` 标签，因为其他 `非托管` 中继器不会检查 `previous` 标签。

群组可以在没有中继器支持的情况下通过在用户的 `kind 10009` 群组列表中的相应标签中添加 `name` 来命名。
