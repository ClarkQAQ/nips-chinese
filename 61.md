NIP-61
======

Nutzaps
-------

`草案` `可选`

Nutzap 是一个 P2PK Cashu 代币，其中支付本身就是收据。

## 高级流程
Alice 想要向 Bob 发送 1 sat 的 nutzap，因为她喜欢事件 `event-id-1`。

### Alice 向 Bob 发送 nutzap
1. Alice 从 Bob 获取事件 `kind:10019`，查看 Bob 信任的铸币厂。
2. 她在该铸币厂铸造代币（或交换她在该铸币厂已有的一些代币），P2PK 锁定到 Bob 在其 `kind:10019` 中列出的公钥。
3. 她向 Bob 指示的中继器发布 `kind:9321` 事件，包含她铸造的证明。

### Bob 接收 nutzap
1. 在某个时刻，Bob 的客户端从他的中继器获取标记他的 `kind:9321` 事件。
2. Bob 的客户端将代币交换到他的钱包中。

## Nutzap 信息事件
```jsonc
{
    "kind": 10019,
    "tags": [
        [ "relay", "wss://relay1" ],
        [ "relay", "wss://relay2" ],
        [ "mint", "https://mint1", "usd", "sat" ],
        [ "mint", "https://mint2", "sat" ],
        [ "pubkey", "<p2pk-pubkey>" ]
    ]
}
```

* `kind:10019` 是一个事件，对其他人知道如何向用户发送资金很有用。
* `relay`：用户将从中读取代币事件的中继器。如果用户想要向用户发送资金，他们应该写入这些中继器。
* `mint`：用户明确同意用于接收资金的铸币厂。客户端不应该在此处未列出的铸币厂上发送资金，否则有烧毁资金的风险。可以使用额外的标记来列出铸币厂支持的基本单位。
* `pubkey`：必须用于 P2PK 锁定接收 nutzaps 的公钥 -- 实现不得使用目标用户的主要 Nostr 公钥。此公钥对应于用户 [nip-60](60.md) _钱包事件_ 中加密的 `privkey` 字段。

### Nutzap 事件
事件 `kind:9321` 是发送者发布的 nutzap 事件，p 标记收件人。输出被 P2PK 锁定到收件人在其 `kind:10019` 事件中指示的公钥。

客户端必须在 P2PK 锁定的公钥前加上 `"02"`（用于 nostr<>cashu 兼容性）。

```jsonc
{
    "kind": 9321,
    "content": "感谢这个好主意。",
    "pubkey": "<发送者公钥>",
    "tags": [
        [ "proof", "{\"amount\":1,\"C\":\"02277c66191736eb72fce9d975d08e3191f8f96afb73ab1eec37e4465683066d3f\",\"id\":\"000a93d6f8a1d2c4\",\"secret\":\"[\\\"P2PK\\\",{\\\"nonce\\\":\\\"b00bdd0467b0090a25bdf2d2f0d45ac4e355c482c1418350f273a04fedaaee83\\\",\\\"data\\\":\\\"02eaee8939e3565e48cc62967e2fde9d8e2a4b3ec0081f29eceff5c64ef10ac1ed\\\"}]\"}" ],
        [ "u", "https://stablenut.umint.cash" ],
        [ "e", "<被 nutzap 的事件 ID>", "<中继器提示>" ],
        [ "k", "<被 nutzap 的种类>"],
        [ "p", "e9fbced3a42dcf551486650cc752ab354347dd413b307484e4fd1818ab53f991" ], // nutzap 的收件人
    ]
}
```

* `.content` 是 nutzap 的可选评论
* `.tags`：
  * `proof` 是一个或多个 P2PK 锁定到收件人在其 `kind:10019` 事件中指定的公钥的证明，包括 DLEQ 证明。
  * `u` 是铸币厂的 URL，完全按照收件人的 `kind:10019` 指定。
  * `p` 是 nutzap 收件人的 Nostr 身份公钥。
  * `e` 是被 nutzap 的事件（如果有）。

## 发送 nutzap

* 发送者获取收件人的 `kind:10019`。
* 发送者在收件人列出的铸币厂之一上铸造/交换 ecash。
* 发送者 P2PK 锁定到收件人在其 `kind:10019` 中指定的公钥

## 接收 nutzaps

客户端应该 REQ nutzaps：
* 使用 `#u` 过滤他们期望从中接收 ecash 的铸币厂。
  * 这是为了防止甚至与用户没有明确信号的铸币厂交互。
* 使用同一用户创建的最近 `kind:7376` 事件的 `since` 过滤。
  * 这可以用作用户已交换的 nutzaps 的标记 -- 客户端可能选择使用其他类型的标记，包括内部状态 -- 这只是一种可能方法的指导。

`{ "kinds": [9321], "#p": ["my-pubkey"], "#u": ["<mint-1>", "<mint-2>"], "since": <latest-created_at-of-kind-7376> }`。

收到新的 nutzap 后，客户端应该将代币交换到用户控制的钱包中，无论是 [NIP-60](60.md) 钱包、他们自己的 LN 钱包还是其他任何东西。

### 更新 nutzap 兑换历史
在领取代币时，客户端应该创建 `kind:7376` 事件并 `e` 标记原始 nutzap 事件。这是为了记录此代币已被领取（不应再次尝试）并作为向收件人发出 ecash 已被兑换的信号。

多个 `kind:9321` 事件可以在同一个 `kind:7376` 事件中标记。

```jsonc
{
    "kind": 7376,
    "content": nip44_encrypt([
        [ "direction", "in" ], // in = 接收, out = 发送
        [ "amount", "1" ],
        [ "e", "<7375-事件 ID>", "<中继器提示>", "created" ] // 创建的新代币事件
    ]),
    "tags": [
        [ "e", "<9321-事件 ID>", "<中继器提示>", "redeemed" ], // 已兑换的 nutzap 事件
        [ "p", "<发送者公钥>" ] // 9321 事件作者的公钥（nutzap 发送者）
    ]
}
```

兑换 nutzap 的事件应该发布到发送者的 [NIP-65](65.md) "read" 中继器。

### 验证 Cashu Zap
在列出或计算任何给定事件收到的 zaps 时，观察者客户端应该：

* 检查接收用户是否已发出标记铸造 cashu 的铸币厂的 `kind:10019`。
* 检查代币是否锁定到用户在其 `kind:10019` 中列出的公钥。
* 查看 `u` 标签并检查代币是否在 `kind:10019` 中列出的铸币厂之一发行。
* 本地验证正在发送的代币的 DLEQ 证明。

所有这些检查都可以离线完成（只要观察者有接收者铸币厂的密钥集和他们的 `kind:10019` 事件），因此过程应该相当快。

### 最终考虑
1. 客户端应该指导其用户在其 `kind:10019` 事件中使用 NUT-11（P2PK）和 NUT-12（DLEQ 证明）兼容铸币厂，以避免接收任何人都可以花费的 nutzaps。
2. 客户端应该按照 NIP-65 中描述的规范化和去重铸币厂 URL。
3. nutzap 事件必须在收件人在其 `kind:10019` 中列出的铸币厂之一中包含证明，并发布到收件人的 NIP-65 中继器，否则可能导致收件人向铸币厂捐赠代币，因为收件人可能永远看不到事件。
