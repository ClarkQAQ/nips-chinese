NIP-60
======

Cashu 钱包
-------------

`草案` `可选`

本 NIP 定义了基于 cashu 的钱包的操作。

cashu 钱包是一种将信息存储在中继器中的钱包，使其可以跨应用程序访问。

本 NIP 的目的是：
* 易用性：新用户无需在其他服务中创建账户即可立即接收资金。
* 互操作性：用户的钱包跟随他们跨应用程序。

本 NIP 不处理用户从其他人那里*接收*资金，它只是为了保持用户钱包的状态。

## 高级流程
1. 用户有一个表示钱包的 `kind:17375` 事件。
2. 用户有表示钱包未花费证明的 `kind:7375` 事件。-- 证明使用用户的私钥加密。
3. 用户有表示钱包支出历史的 `kind:7376` 事件 -- 此历史仅供参考，完全可选。

### 钱包事件
```jsonc
{
    "kind": 17375,
    "content": nip44_encrypt([
        [ "privkey", "hexkey" ],
        [ "mint", "https://mint1" ],
        [ "mint", "https://mint2" ]
    ]),
    "tags": []
}
```

钱包事件是可替换事件 `kind:17375`。

标签：
* `mint` - 此钱包使用的铸币厂 -- 必须有一个或多个铸币厂标签。
* `privkey` - 用于解锁 P2PK ecash 的私钥。必须在 `.content` 字段中加密存储。**这是专门用于钱包的不同私钥，与用户的 Nostr 私钥没有任何关联** -- 这仅用于接收 [NIP-61](61.md) nutzaps。

### 代币事件
代币事件用于记录未花费的证明。

同一个铸币厂可以有多个 `kind:7375` 事件，每个 `kind:7375` 事件内可以有多个证明。

```jsonc
{
    "kind": 7375,
    "content": nip44_encrypt({
        "mint": "https://stablenut.umint.cash",
        "proofs": [
            // 默认 cashu 格式的一个或多个证明
            {
                "id": "005c2502034d4f12",
                "amount": 1,
                "secret": "z+zyxAVLRqN9lEjxuNPSyRJzEstbl69Jc1vtimvtkPg=",
                "C": "0241d98a8197ef238a192d47edf191a9de78b657308937b4f7dd0aa53beae72c46"
            }
        ],
        // 在创建此代币时被销毁的代币（有助于钱包状态转换）
        "del": [ "token-event-id-1", "token-event-id-2" ]
    }),
    "tags": []
}
```

 * `.content` 是 [NIP-44](44.md) 加密载荷：
   * `mint`：证明所属的铸币厂。
   * `proofs`：未编码的证明
   * `del`：被此代币创建销毁的代币 ID。这有助于状态转换。

当代币的一个或多个证明被花费时，代币事件应该被 [NIP-09](09.md) 删除，如果同一代币事件中有一些证明未花费，应该创建一个新的代币事件，滚动未花费的证明并将任何找零输出添加到新代币事件中（找零输出应包含 `del` 字段）。

在 [NIP-09](09.md) 过程中创建的 `kind:5` _删除事件_ 必须有标签 `["k", "7375"]` 以允许对状态转换感兴趣的客户端轻松过滤。

### 支出历史事件
当余额变化时，客户端应该发布 `kind:7376` 事件来创建交易历史。

```jsonc
{
    "kind": 7376,
    "content": nip44_encrypt([
        [ "direction", "in" ], // in = 接收, out = 发送
        [ "amount", "1" ],
        [ "e", "<创建的代币事件 ID>", "", "created" ]
    ]),
    "tags": [
        [ "e", "<创建的代币事件 ID>", "", "redeemed" ]
    ]
}
```

* `direction` - 交易方向；`in` 表示接收资金，`out` 表示发送资金。

客户端必须添加 `e` 标签来创建被销毁和创建的代币事件的引用，以及标签含义的标记：
* `created` - 创建了新的代币事件。
* `destroyed` - 代币事件被销毁。
* `redeemed` - [NIP-61](61.md) nutzap 被兑换。

所有标签都可以使用 [NIP-44](44.md) 加密。客户端应该保持带有 `redeemed` 标记的 `e` 标签不加密。

可以添加多个 `e` 标签，应该加密，除了带有 `redeemed` 标记的标签。

## 流程
想要检查用户钱包信息的客户端首先从用户的中继器获取 `kind:10019` 事件，如果没有找到事件，应该回退到使用用户的 [NIP-65](65.md) 中继器。

### 获取钱包和代币列表
从这些中继器，客户端应该获取钱包和代币事件。

`"kinds": [17375, 7375], "authors": ["<my-pubkey>"]`

### 获取证明

### 花费代币
如果 Alice 从此代币事件花费 4 sats
```jsonc
{
    "kind": 7375,
    "id": "event-id-1",
    "content": nip44_encrypt({
        "mint": "https://stablenut.umint.cash",
        "proofs": [
            { "id": "1", "amount": 1 },
            { "id": "2", "amount": 2 },
            { "id": "3", "amount": 4 },
            { "id": "4", "amount": 8 },
        ]
    }),
    "tags": []
}
```

她的客户端：
* 必须滚动未花费的证明：
```jsonc
{
    "kind": 7375,
    "id": "event-id-2",
    "content": nip44_encrypt({
        "mint": "https://stablenut.umint.cash",
        "proofs": [
            { "id": "1", "amount": 1 },
            { "id": "2", "amount": 2 },
            { "id": "4", "amount": 8 },
        ],
        "del": [ "event-id-1" ]
    }),
    "tags": []
}
```
* 必须删除事件 `event-id-1`
* 应该将 `event-id-1` 添加到已删除代币 ID 的 `del` 数组中。
* 应该创建 `kind:7376` 事件来记录支出
```jsonc
{
    "kind": 7376,
    "content": nip44_encrypt([
        [ "direction", "out" ],
        [ "amount", "4" ],
        [ "e", "<event-id-1>", "", "destroyed" ],
        [ "e", "<event-id-2>", "", "created" ],
    ]),
    "tags": []
}
```

### 兑换报价（可选）
在铸币厂创建报价时，可以使用事件来保持报价 ID 的状态，这将用于检查报价何时被支付。这些事件应该使用 [NIP-40](40.md) 的过期标签创建，有效期为 2 周（这大约是闪电支付可能在传输中的最大时间）。

但是，应用程序开发人员应该在可能时使用本地状态，只有在其应用程序上下文中有意义时才发布此事件。

```jsonc
{
    "kind": 7374,
    "content": nip44_encrypt("quote-id"),
    "tags": [
        [ "expiration", "<过期时间戳>" ],
        [ "mint", "<铸币厂 URL>" ]
    ]
}
```

## 附录 1：验证证明
客户端可以选择验证证明以确保它们不是从旧状态工作；此逻辑留给特定实现决定何时以及为什么这样做，但如果检查某些证明并认为已被花费，客户端应删除代币并滚动任何未花费的证明。
